<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
       <meta http-equiv="X-UA-Compatible" content="IE=edge">
       <meta name="viewport" content="width=device-width, initial-scale=1">
       <link rel="icon" type="image/x-icon" href="Logo/icon.png" />
       <title>Sản Phẩm</title>
       <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
       <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
       <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet"/>
       <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
       <link rel="stylesheet" href="css/style_shop.css">
       <link rel="stylesheet" href="css/style_index.css">
       <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
       
    </head>
<body>
    
    <div id="navbar-container"> </div>
    <!-- chèn -->
    <div class="shop-box-inner">
        <div class="container">
            <div class="row">
                <div class="col-xl-9 col-lg-9 col-sm-12 col-xs-12 shop-content-right">
                    <div class="right-product-box">
                        <div class="product-item-filter row">
                            <div class="col-12 col-sm-8 text-center text-sm-left">
                                <div class="toolbar-sorter-right d-flex justify-content-start align-items-center">
                                    <div class="sort-icons" >
                                       
                                        <ul class="nav nav-tabs ml-auto">
                                            <li>
                                                <a  id="sortAsc" class="icon" data-toggle="tab"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-caret-up-fill" viewBox="0 0 16 16">
                                                    <path d="m7.247 4.86-4.796 5.481c-.566.647-.106 1.659.753 1.659h9.592a1 1 0 0 0 .753-1.659l-4.796-5.48a1 1 0 0 0-1.506 0z"/>
                                                  </svg> </a>
                                            </li>
                                            <li>
                                                <a id="sortDesc" class="icon"  href="#list-view" data-toggle="tab"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-caret-down-fill" viewBox="0 0 16 16">
                                                    <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
                                                  </svg></i> </a>
                                            </li>
                                        </ul>
                                        
                                    </div>
                                   
                                    <select id="sortBy" class=" show-tick form-control" >
                                        
                                        <option value="id">Sắp xếp theo ID sản phẩm</option>
                                        <option value="price">Sắp xếp sản phẩm theo giá</option>
                                        <option value="rating">Sắp xếp sản phẩm theo đánh giá</option>
                                        <option value="like">Sắp xếp sản phẩm theo yêu thích</option>
                                        <option value="sold">Sắp xếp sản phẩm theo lượng sản phẩm bán ra</option>
                                    </select>
                                </div>
                                
                            </div>
                            <div class="col-12 col-sm-4 text-center text-sm-right">
                                <ul class="nav nav-tabs ml-auto">
                                    <li>
                                        <a class="nav-link active" href="#grid-view" data-toggle="tab"> <i class="fa fa-th"></i> </a>
                                    </li>
                                    <li>
                                        <a class="nav-link" href="#list-view" data-toggle="tab"> <i class="fa fa-list-ul"></i> </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="product-categorie-box">
                            <div class="tab-content">
                                <div role="tabpanel" class="tab-pane fade show active" id="grid-view">
                                    <div class="row">
                                        <div id="productgrid"></div>
                                        
                                    </div>
                                </div>
                                <div role="tabpanel" class="tab-pane fade" id="list-view">
                                    <div class="list-view-box">
                                        <div id="productlist"></div>
                                        
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                        <div class="product-item-filter row">
                              <!-- Phân trang -->
                                    <div class="pagination">
                                        <ul class="d-flex list-unstyled" style="margin-left: 300px;">
                                                <li class="page-item">
                                                    <a class="page-link" id="prevPage">
                                                        <<
                                                    </a>
                                                </li>
                                                <li class="page-item">
                                                    <a class="page-link" id="currentPage"></a>
                                                </li>
                                                <li class="page-item">
                                                    <a class="page-link" id="nextPage">
                                                        >> 
                                                    </a>
                                                </li> 
                                        </ul>
                                    </div>
                        </div>
                            
                            
                    </div>
                </div>
                <div class="col-xl-3 col-lg-3 col-sm-12 col-xs-12 sidebar-shop-left">
                    <div class="product-categori">
                        <div class="search-product">
                            <form action="#">
                                <input class="form-control" id="search" placeholder="Tìm kiếm sản phẩm" type="text">
                                <button type="submit" id="filterSearch"> <i class="fa fa-search"></i> </button>
                            </form>
                        </div>
                        <div class="filter-sidebar-left">
                            <div class="title-left">
                                <h3 class="h3-shop">Danh Sách Loại Sản Phẩm</h3>
                            </div>
                            <div class="list-group list-group-collapse list-group-sm list-group-tree" id="productType" data-children=".sub-men">
                                <a class="list-group-item list-group-item-action" data-id="">Tất cả sản phẩm</a>
                            </div>
                        </div>
                        <div class="filter-price-left">
                            <div class="title-left">
                                <h3 class="h3-shop">Tìm kiếm theo mức giá</h3>
                            </div>
                            <div class="price-box-slider">
                                <div id="slider-range"></div>
                                <p>
                                    <input type="text" id="amount" readonly style="border:0; font-weight:bold;">
                                    <button class="btn-shop hvr-hover" type="button" id="filterBtn">Chọn</button>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="footer-container">
   
    <script>
        let totalItems = 0; 
        let totalPages = 1; 
        let currentPage = 1;
        let typeId = null;
        let sortType = 'asc'; 
        let sortBy = ''; 
        let minPrice, maxPrice;
    
        $(document).ready(function () {
            loadProductTypes(); 
            loadProducts(); 
            
            // Sự kiện khi nhấn nút tìm kiếm
            $('#filterSearch').click(function () {
                currentPage = 1; // Reset về trang 1 khi tìm kiếm
                loadProducts();
            });
    
            // Sự kiện chuyển trang trước
            $('#prevPage').click(function () {
                if (currentPage > 1) {
                    currentPage--; 
                    loadProducts(); 
                }
            });
    
            // Sự kiện chuyển trang tiếp theo
            $('#nextPage').click(function () {
                if (currentPage < totalPages) {
                    currentPage++; 
                    loadProducts(); 
                }
            });
    
            // Sự kiện thay đổi giá trị min/max giá trị của slider
            $("#slider-range").slider({
                range: true,
                min: 0,
                max: 5000, 
                values: [1000, 3000], 
                slide: function(event, ui) {
                    $("#amount").val("Giá: " + ui.values[0] + " - " + ui.values[1]);
                }
            });
            $("#amount").val("Giá: " + $("#slider-range").slider("values", 0) + " - " + $("#slider-range").slider("values", 1));
    
            // Lọc sản phẩm theo giá
            $("#filterBtn").on("click", function() {
                minPrice = $("#slider-range").slider("values", 0);
                maxPrice = $("#slider-range").slider("values", 1);
                currentPage = 1;
                loadProducts();
            });
    
            // Sự kiện sắp xếp tăng dần
            $('#sortAsc').click(function () {
                sortType = 'asc';
                currentPage = 1;
                loadProducts();
            });
    
            // Sự kiện sắp xếp giảm dần
            $('#sortDesc').click(function () {
                sortType = 'desc';
                currentPage = 1;
                loadProducts();
            });
    
            // Lọc theo loại sản phẩm
            $('#productType').on('click', '.list-group-item', function (event) {
                event.preventDefault();
                typeId = $(this).data('id'); 
                currentPage = 1; 
                loadProducts();
                $('.list-group-item').removeClass('active'); 
                $(this).addClass('active'); 
            });
    
            $('#sortBy').change(function () {
                sortBy = $(this).val(); 
                currentPage = 1; 
                loadProducts(); 
            });
        });
    
        // Hàm cập nhật trạng thái của các nút phân trang và số trang
        function updatePaginationButtons() {
            
            $('#prevPage').prop('disabled', currentPage <= 1);
    
            
            $('#nextPage').prop('disabled', currentPage >= totalPages);
    
            
            $('#pageInfo').text(`Trang ${currentPage} / ${totalPages}`);
        }
        
        // Hàm tải danh sách loại sản phẩm
        function loadProductTypes() {
            $.ajax({
                url: 'https://localhost:7060/api/ProductTypes', 
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    const productType = $('#productType');
                    data.data.forEach(function (type) {
                        productType.append(`<a class="list-group-item list-group-item-action" data-id="${type.id}">${type.name}</a>`);
                    });
                },
                error: function (xhr, status, error) {
                    console.error("Đã xảy ra lỗi khi lấy danh sách loại sản phẩm: " + error);
                }
            });
        }
    
        function loadProducts() {
            const search = $('#search').val().trim();
            const pageSize = $('#pageSize').val() || 10;
           
    
            let url = `https://localhost:7060/api/Products?page=${currentPage}&pageSize=${pageSize}`;
    
            if (search) {
                url += `&search=${encodeURIComponent(search)}`;
            }
    
            if (minPrice || maxPrice) {
                url += `&fByPrice=${minPrice || 0}_${maxPrice || ''}`;
            }
    
            if (typeId) {
                url += `&fByType=${typeId}`;
            }
    
            if (sortBy) {
                url += `&sortBy=${sortBy}`;
            }
    
            if (sortType) {
                url += `&sortType=${sortType}`;
            }
    
            $.ajax({
                url: url,
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    let productGridHtml = '';
                    let productListHtml = '';
    
                    data.data.forEach(function (product) {
                        let imagePath = 'Images/';
                        imagePath += product.images && product.images.length > 0 ? product.images[0].path : 'default-image.jpg';
                        let avgRating = product.rating > 0 ? product.rating.toFixed(1) : "Chưa có đánh giá";
    
                        // Thêm sản phẩm vào dạng lưới
                        productGridHtml += `
                            <div class="col-sm-6 col-md-6 col-lg-4 col-xl-4">
                                <div class="products-single fix">
                                    <div class="box-img-hover">
                                        <div class="type-lb">
                                            <p class="new">${avgRating}⭐</p>
                                        </div>
                                        <img height="300" width="300" src="${imagePath}" class="img-fluid" alt="${product.name}" >
                                        <div class="mask-icon">
                                            <a class="cart" href="#">Thêm vào giỏ</a>
                                        </div>
                                    </div>
                                    <div class="why-text">
                                        <h4>${product.name}</h4>
                                        <h5 class="h5-shop">$${product.price}</h5>
                                    </div>
                                </div>
                            </div>`;
    
                        // Thêm sản phẩm vào dạng danh sách
                        productListHtml += `
                            <div class="row mb-5">
                                <div class="col-sm-6 col-md-6 col-lg-4 col-xl-4">
                                    <div class="products-single fix">
                                        <div class="box-img-hover">
                                            <div class="type-lb">
                                                <p class="new">${avgRating}⭐</p>
                                            </div>
                                            <img src="${imagePath}" class="img-fluid" alt="${product.name}">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6 col-md-6 col-lg-8 col-xl-8">
                                    <div class="why-text full-width">
                                        <h4>${product.name}</h4>
                                        <p class="p-shop"><b>Mô tả:</b> ${product.description}</p>
                                        <p class="p-shop"><b>Số lượng:</b> ${product.quantity}</p>
                                         <h5 class="h5-shop mb-3">$${product.price}</h5>
                                         </br>
                                        <a class="btn-shop hvr-hover" href="#">Thêm vào giỏ</a>
                                    </div>
                                </div>
                            </div>`;
                    });
    
                    $('#productgrid').html(productGridHtml); 
                    $('#productlist').html(productListHtml); 
                    $('#currentPage').text(currentPage);
    
                    // Cập nhật tổng số sản phẩm và tính tổng số trang
                    totalPages = data.totalPage;
    
                    // Cập nhật nút phân trang
                    updatePaginationButtons();
                    console.log("Total Pages: ", totalPages);
                },
                error: function (xhr, status, error) {
                    console.error("Đã xảy ra lỗi: " + error);
                }
            });
        }
    </script>
    
    
    

    <!-- ALL JS FILES -->  
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.6/umd/popper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.superslides/2.0.1/jquery.superslides.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.14.0-beta3/js/bootstrap-select.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inview/1.2.2/jquery.inview.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Isotope/3.0.6/isotope.pkgd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.nicescroll/3.7.6/jquery.nicescroll.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation/1.19.3/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-form-validator/2.3.26/validator.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script> 

    <script>
        $(document).ready(function () {
          $("#navbar-container").load(
            "./fragments/navbar.html",
            function (response, status, xhr) {
              if (status === "success") {
                // Đảm bảo rằng tất cả các phần tử đã được nạp trước khi thực hiện kiểm tra trạng thái
                const token = localStorage.getItem("token");
                const avatar = localStorage.getItem("avatar");
  
                const userAvatar = document.getElementById("user-avatar");
                const loginRegister = document.getElementById("login-register");
                const logoutBtn = document.getElementById("logout-btn");
  
                if (token && avatar) {
                  userAvatar.style.display = "block";
                  loginRegister.style.display = "none";
                  userAvatar.src = `./Images/avatar/${avatar}`;
                  logoutBtn.style.display = "block";
  
                  logoutBtn.addEventListener("click", function () {
                    localStorage.removeItem("token");
                    localStorage.removeItem("avatar");
                    window.location.href = "/login.html";
                  });
                } else {
                  userAvatar.style.display = "none";
                  logoutBtn.style.display = "none";
                  loginRegister.style.display = "block";
                }
              } else {
                console.error(
                  "Error loading navbar:",
                  xhr.status,
                  xhr.statusText
                );
              }
            }
          );
        });
      </script>
     <!-- KHA AI -->
     <script>
        $(document).ready(function() { 
            //$('#navbar-container').load('./fragments/navbar.html', function(response, status, xhr) {});
            $('#footer-container').load('./fragments/footer_2.html', function(response, status, xhr) {});
        });

    </script>
    
</body>
</html>
