<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Quản lý sản phẩm</title>

    <link href="../css/style_shop_dashboard.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="icon" href="../Logo/icon.png" type="image/x-icon" />
    <script
      src="https://use.fontawesome.com/releases/v6.3.0/js/all.js"
      crossorigin="anonymous"
    ></script>
    <!-- Thêm jQuery từ CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- jQuery CDN -->

    <!-- Bootstrap JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body class="sb-nav-fixed">
    <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
      <ul class="navbar-nav ms-auto me-3 me-lg-4">
        <li class="nav-item">
          <div class="profile-info d-flex align-items-center">
            <img
              src="../Images/avatar/no-avatar.jpg"
              class="rounded-circle me-2"
              width="32"
              height="32"
              alt="Avatar"
            />
            <span class="text-white">Xin chào, [Tên người dùng]</span>
          </div>
        </li>

        <li class="nav-item ms-3">
          <button id="logoutBtn" class="btn custom-logout-btn">
            Đăng xuất
          </button>
        </li>
      </ul>
    </nav>

    <div id="layoutSidenav">
      <div id="layoutSidenav_nav">
        <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
          <div class="sb-sidenav-menu">
            <div class="nav">
              <div class="sb-sidenav-menu-heading text-center">
                <img
                  src="../Logo/Logo.png"
                  alt="Logo"
                  class="logo-img"
                  style="width: 200px; height: 50px"
                />
              </div>
              <hr />
              <h5 class="text-center">SHOP CỦA TÔI</h5>
              <a class="nav-link" href="dashboard.html">
                <div class="sb-nav-link-icon">
                  <i class="fas fa-tachometer-alt"></i>
                </div>
                Sản phẩm
              </a>
              <a class="nav-link" href="order.html">
                <div class="sb-nav-link-icon">
                  <i class="fas fa-tachometer-alt"></i>
                </div>
                Đơn hàng
              </a>
            </div>
          </div>
        </nav>
      </div>

      <div id="layoutSidenav_content">
        <main>
          <div class="container-fluid px-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2 class="mt-4">QUẢN LÝ SẢN PHẨM</h2>
            </div>

            <div class="row">
              <!-- Cột Danh sách sản phẩm -->
              <div class="col-md-9">
                <div class="card mb-4">
                  <div
                    class="card-header d-flex justify-content-between align-items-center"
                  >
                    <div class="d-flex align-items-center">
                      <i class="fas fa-table me-1"></i>
                      <span>Danh sách sản phẩm</span>
                    </div>

                    <!-- Phần Sắp xếp -->
                    <div class="d-flex align-items-center">
                      <label for="SortBy" class="form-label me-2 mb-0"
                        >Sắp xếp theo:</label
                      >
                      <select
                        class="form-select form-select-sm me-2"
                        id="SortBy"
                        style="width: auto"
                      >
                        <option value="id">ID</option>
                        <option value="rating">Đánh giá</option>
                        <option value="like">Yêu thích</option>
                        <option value="sold">Số lượng bán</option>
                        <option value="price">Giá</option>
                      </select>
                      <select
                        class="form-select form-select-sm"
                        id="SortType"
                        style="width: auto"
                      >
                        <option value="asc">Tăng dần</option>
                        <option value="desc">Giảm dần</option>
                      </select>
                    </div>

                    <button
                      class="btn btn-success"
                      data-bs-toggle="modal"
                      data-bs-target="#addProductModal"
                      style="background-color: #3a6d8c; border: none"
                    >
                      <i class="fa-solid fa-plus"></i> Thêm sản phẩm
                    </button>
                  </div>

                  <div class="card-body">
                    <table class="table table-hover">
                      <thead>
                        <tr>
                          <th>Ảnh</th>
                          <th>Tên</th>
                          <th>Giá</th>
                          <th>Số lượng</th>
                          <th>Thao tác</th>
                        </tr>
                      </thead>
                      <tbody id="productTableBody">
                        <!-- Dữ liệu sẽ được chèn tại đây -->
                      </tbody>
                    </table>
                  </div>
                </div>
                <ul class="pagination" id="paginationControls">
                  <!-- Các trang sẽ được chèn tại đây bằng JavaScript -->
                </ul>
              </div>

              <!-- Cột Bộ lọc và Tìm kiếm-->
              <div class="col-md-3">
                <div class="card mb-4">
                  <div class="position-relative">
                    <input
                      type="text"
                      class="form-control ps-5"
                      id="Search"
                      placeholder="Tìm kiếm sản phẩm"
                    />

                    <i
                      class="fa-solid fa-magnifying-glass position-absolute"
                      style="
                        left: 15px;
                        top: 50%;
                        transform: translateY(-50%);
                        color: #aaa;
                      "
                    ></i>
                  </div>
                </div>

                <!-- Card Bộ lọc sản phẩm -->
                <div class="card mb-4">
                  <div class="card-header custom-card-header">
                    <h5 class="mb-0">Bộ lọc sản phẩm</h5>
                  </div>
                  <div class="card-body">
                    <form class="row g-3">
                      <div class="col-12">
                        <label for="productTypeId" class="form-label"
                          >Loại sản phẩm</label
                        >
                        <select class="form-select" id="productTypeId">
                          <!-- Các option loại sản phẩm sẽ được thêm vào đây bằng JavaScript -->
                        </select>
                      </div>

                      <!-- Khoảng giá -->
                      <div class="col-12">
                        <label class="form-label">Khoảng giá</label>
                        <div class="d-flex align-items-center">
                          <div class="col">
                            <input
                              type="text"
                              class="form-control"
                              id="minPrice"
                              placeholder=".000 VND"
                            />
                          </div>
                          <span class="mx-2">-</span>
                          <div class="col">
                            <input
                              type="text"
                              class="form-control"
                              id="maxPrice"
                              placeholder=".000 VND"
                            />
                          </div>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
        <footer id="footer-container"></footer>
      </div>
    </div>

    <!-- Modal thêm sản phẩm -->
    <div
      class="modal fade"
      id="addProductModal"
      tabindex="-1"
      aria-labelledby="addProductModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addProductModalLabel">Thêm Sản Phẩm</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addProductForm">
              <div class="mb-3">
                <label for="productName" class="form-label">Tên sản phẩm</label>
                <input
                  type="text"
                  class="form-control"
                  id="productName"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="productDescription" class="form-label">Mô tả</label>
                <textarea
                  class="form-control"
                  id="productDescription"
                  required
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="productPrice" class="form-label"
                  >Giá (.000 VND)</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="productPrice"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="productQuantity" class="form-label">Số lượng</label>
                <input
                  type="number"
                  class="form-control"
                  id="productQuantity"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="productTypeId" class="form-label"
                  >Loại sản phẩm</label
                >
                <select class="form-control" id="addProductTypeId" required>
                  <option value="">Chọn loại sản phẩm</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="submitProduct"
              style="background-color: #6a9ab0; border: none"
            >
              Thêm sản phẩm
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal chi tiết sản phẩm -->
    <div
      class="modal fade"
      id="productDetailsModal"
      tabindex="-1"
      aria-labelledby="productDetailsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="productDetailsModalLabel">
              Chi tiết sản phẩm
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p>
              <strong>Tên sản phẩm:</strong>
              <span id="productDetailsName"></span>
            </p>
            <p>
              <strong>Mô tả:</strong>
              <span id="productDetailsDescription"></span>
            </p>
            <p><strong>Giá:</strong> <span id="productDetailsPrice"></span></p>
            <p>
              <strong>Phần trăm giảm giá:</strong>
              <span id="productDetailsDiscount"></span>%
            </p>
            <p>
              <strong>Số lượng:</strong>
              <span id="productDetailsQuantity"></span>
            </p>
            <p>
              <strong>Số lượng đã bán:</strong>
              <span id="productDetailsSoldQuantity"></span>
            </p>
            <p>
              <strong>Số lượt thích:</strong>
              <span id="productDetailsLikeQuantity"></span>
            </p>
            <p>
              <strong>Đánh giá:</strong> <span id="productDetailsRating"></span>
            </p>

            <!-- Loại sản phẩm với phần "Xem thêm" -->
            <p>
              <strong>Loại sản phẩm:</strong>
              <span id="productDetailsType"></span>
              <a href="#" id="productTypeMoreLink" class="text-primary"
                >Xem thêm</a
              >
              <span
                id="productDetailsTypeDescription"
                style="display: none"
              ></span>
            </p>

            <p>
              <strong>Cửa hàng:</strong> <span id="productDetailsShop"></span>
            </p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal cập nhật sản phẩm -->
    <div
      class="modal fade"
      id="editProductModal"
      tabindex="-1"
      aria-labelledby="editProductModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editProductModalLabel">Sửa Sản Phẩm</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editProductForm">
              <div class="mb-3">
                <label for="editProductName" class="form-label"
                  >Tên sản phẩm</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="editProductName"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editProductDescription" class="form-label"
                  >Mô tả</label
                >
                <textarea
                  class="form-control"
                  id="editProductDescription"
                  required
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="editProductPrice" class="form-label">Giá</label>
                <input
                  type="number"
                  class="form-control"
                  id="editProductPrice"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editProductQuantity" class="form-label"
                  >Số lượng</label
                >
                <input type="hidden" id="editProductId" />
                <input
                  type="number"
                  class="form-control"
                  id="editProductQuantity"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="productTypeId" class="form-label"
                  >Loại sản phẩm</label
                >
                <select class="form-control" id="editProductTypeId" required>
                  <!-- Các loại sản phẩm sẽ được thêm vào đây -->
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="saveProductChanges"
            >
              Cập nhật sản phẩm
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal ảnh -->
    <div
      class="modal fade"
      id="productImagesModal"
      tabindex="-1"
      aria-labelledby="productImagesModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg" style="height: 500px">
        <div class="modal-content" style="height: 100%">
          <div class="modal-header">
            <h5 class="modal-title" id="productImagesModalLabel">
              Hình ảnh sản phẩm
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div
            class="modal-body"
            style="height: calc(100% - 60px); overflow-y: auto"
          >
            <div id="productImagesContainer" class="row">
              <!-- Các hình ảnh sẽ được thêm vào đây bằng JavaScript -->
            </div>
          </div>
          <div class="modal-footer">
            <form id="uploadForm" class="d-flex align-items-center">
              <div class="mb-3 me-2">
                <label for="imageInput" class="form-label">Thêm ảnh:</label>
                <input
                  type="file"
                  class="form-control"
                  id="imageInput"
                  accept="image/*"
                  multiple
                  required
                />
              </div>

              <button type="button" class="btn btn-primary" id="uploadButton">
                Thêm
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <script>
      const accessToken = localStorage.getItem("token");
      const shopId = sessionStorage.getItem("shopId");
      $(document).ready(function () {
        const logoutBtn = $("#logoutBtn");

        // Đăng xuất
        logoutBtn.on("click", function () {
          localStorage.removeItem("token");
          localStorage.removeItem("avatar");
          window.location.href = "../login.html";
        });

        // Hàm gọi API để lấy danh sách sản phẩm với bộ lọc
        function fetchProducts(shopId, accessToken, page = 1) {
          const productType = $("#productTypeId").val();
          const minPrice = $("#minPrice").val();
          const maxPrice = $("#maxPrice").val();
          const searchQuery = $("#Search").val();
          const sortBy = $("#SortBy").val();
          const sortType = $("#SortType").val();

          let apiUrl = `https://localhost:7060/api/Products/shop/${shopId}?Page=${page}&Pagination=true&`;
          console.log(apiUrl);
          if (productType) apiUrl += `FByType=${productType}&`;
          if (minPrice && maxPrice)
            apiUrl += `FByPrice=${minPrice}_${maxPrice}&`;
          if (searchQuery)
            apiUrl += `Search=${encodeURIComponent(searchQuery)}&`;
          if (sortBy) apiUrl += `SortBy=${sortBy}&`;
          if (sortType) apiUrl += `SortType=${sortType}`;

          $.ajax({
            url: apiUrl,
            type: "GET",
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
            success: function (response) {
              console.log(response.totalPage); // Kiểm tra xem totalPages có đúng không
              if (Array.isArray(response.data)) {
                renderProductTable(response.data);
                setupPagination(response.totalPage, page); // Thêm tổng số trang từ API
              } else {
                console.error("Dữ liệu sản phẩm không đúng định dạng.");
              }
            },
            error: function (xhr) {
              console.error("Lỗi khi gọi API:", xhr.responseText);
            },
          });
        }

        // Hàm render danh sách sản phẩm ra bảng HTML
        function renderProductTable(products) {
          const productTableBody = $("#productTableBody");
          productTableBody.empty();

          if (products.length === 0) {
            productTableBody.append(
              "<tr><td colspan='6'>Không có sản phẩm nào để hiển thị.</td></tr>"
            );
            return;
          }
          products.forEach((product) => {
            const row = `
      <tr>
        <td>
          <img src="${
            product.images.length > 0 && product.images[0]?.path
              ? `../Images/${product.images[0].path}`
              : "../Images/default-image.jpg"
          }" class="product-image" data-id="${
              product.id
            }" style="cursor: pointer; width: 50px; height: 50px;">
        </td>
        <td>${product.name}</td>
       
        <td>${(product.price * 1000).toLocaleString()} VND</td>
        <td>${product.quantity}</td>
        <td>
           <button class="btn btn-primary btn-sm btn-details" title="Chi tiết" data-bs-toggle="modal" data-bs-target="#productDetailsModal" data-id="${
             product.id
           }">
    <i class="fas fa-info-circle"></i>
  </button>
          <button class="btn btn-success btn-sm btn-update" title="Cập nhật" data-bs-toggle="modal" data-bs-target="#editProductModal" data-id="${
            product.id
          }">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-danger btn-sm btn-delete" title="Xóa" data-id="${
            product.id
          }">
            <i class="fas fa-trash-alt"></i>
          </button>
        </td>
      </tr>`;
            productTableBody.append(row);
          });

          // Gắn sự kiện click cho nút xóa
          $(".btn-delete").on("click", function () {
            const productId = $(this).data("id");
            if (confirm("Bạn có chắc chắn muốn xóa sản phẩm này?")) {
              deleteProduct(productId);
            }
          });
          // Gắn sự kiện click cho nút chi tiết
          $(".btn-details").on("click", function () {
            const productId = $(this).data("id");

            $.ajax({
              url: `https://localhost:7060/api/Products/${productId}`,
              method: "GET",
              success: function (product) {
                // Định dạng giá với dấu chấm phân cách hàng nghìn và thêm " VND", nhân giá với 1000
                const formattedPrice = `${(
                  product.price * 1000
                ).toLocaleString()} VND`;
                $("#productDetailsPrice").text(formattedPrice);

                // Các thiết lập khác cho modal chi tiết
                $("#productDetailsName").text(product.name);
                $("#productDetailsDescription").text(product.description);
                $("#productDetailsDiscount").text(product.discountPercent);
                $("#productDetailsQuantity").text(product.quantity);
                $("#productDetailsSoldQuantity").text(product.soldQuantity);
                $("#productDetailsLikeQuantity").text(product.likeQuantity);

                // Kiểm tra rating và hiển thị
                if (product.rating > 0) {
                  $("#productDetailsRating").html(`${product.rating} ⭐`);
                } else {
                  $("#productDetailsRating").text("Chưa có đánh giá");
                }

                $("#productDetailsType").text(product.productType.name);
                $("#productDetailsTypeDescription").text(
                  product.productType.description
                );
                $("#productDetailsShop").text(product.shop.name);

                // Sự kiện "Xem thêm" cho mô tả loại sản phẩm
                $("#productTypeMoreLink")
                  .off("click")
                  .on("click", function (e) {
                    e.preventDefault();
                    $("#productDetailsTypeDescription").toggle();
                    $(this).text(
                      $("#productDetailsTypeDescription").is(":visible")
                        ? "Ẩn bớt"
                        : "Xem thêm"
                    );
                  });

                // Mở modal chi tiết sản phẩm
                $("#productDetailsModal").modal("show");
              },
              error: function () {
                alert("Không thể tải dữ liệu chi tiết sản phẩm!");
              },
            });
          });

          // Gắn sự kiện click cho nút cập nhật
          $(".btn-update").on("click", function () {
            const productId = $(this).data("id");

            $.ajax({
              url: `https://localhost:7060/api/Products/${productId}`,
              method: "GET",
              success: function (product) {
                fetchProductTypes("#editProductTypeId").then(() => {
                  // Thiết lập giá trị cho các trường trong modal
                  $("#editProductName").val(product.name);
                  $("#editProductDescription").val(product.description);
                  $("#editProductPrice").val(product.price);
                  $("#editProductQuantity").val(product.quantity);
                  $("#editProductId").val(product.id);
                  $("#editProductTypeId").val(product.productType.id);

                  // Mở modal
                  $("#editProductModal").modal("show");
                });
              },
              error: function () {
                alert("Không thể tải dữ liệu sản phẩm!");
              },
            });
          });
        }

        // Hàm thiết lập phân trang
        function setupPagination(totalPage, currentPage) {
          const paginationControls =
            document.getElementById("paginationControls");
          paginationControls.innerHTML = "";

          // Nút Previous
          const prevButton = document.createElement("li");
          prevButton.className =
            "page-item" + (currentPage === 1 ? " disabled" : "");
          prevButton.innerHTML = `<a class="page-link" href="#" tabindex="-1">Trước</a>`;
          prevButton.onclick = () => {
            if (currentPage > 1)
              fetchProducts(shopId, accessToken, currentPage - 1);
          };
          paginationControls.appendChild(prevButton);

          // Tạo nút cho từng trang
          for (let i = 1; i <= totalPage; i++) {
            const pageItem = document.createElement("li");
            pageItem.className =
              "page-item" + (i === currentPage ? " active" : "");
            pageItem.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            pageItem.onclick = () => fetchProducts(shopId, accessToken, i);
            paginationControls.appendChild(pageItem);
          }

          // Nút Next
          const nextButton = document.createElement("li");
          nextButton.className =
            "page-item" + (currentPage === totalPage ? " disabled" : "");
          nextButton.innerHTML = `<a class="page-link" href="#">Sau</a>`;
          nextButton.onclick = () => {
            if (currentPage < totalPage)
              fetchProducts(shopId, accessToken, currentPage + 1);
          };
          paginationControls.appendChild(nextButton);
        }

        $("#SortBy, #SortType, #Search, #minPrice, #maxPrice").on(
          "change",
          function () {
            const shopId = sessionStorage.getItem("shopId");
            fetchProducts(shopId, accessToken, 1);
          }
        );
        // Gọi API để lấy thông tin tài khoản
        $.ajax({
          url: "https://localhost:7060/api/Accounts",
          type: "GET",
          headers: {
            Authorization: `Bearer ${accessToken}`,
          },
          success: function (response) {
            if (response && response.shop && response.shop.id) {
              const shopId = response.shop.id;
              const shopName = response.shop.name;
              const avatar = response.avatar;
              sessionStorage.setItem("shopId", shopId);
              // Gọi hàm để lấy danh sách sản phẩm
              fetchProducts(shopId, accessToken, 1);

              $(".text-white").text(`Xin chào, ${shopName}`);
              $("img.rounded-circle").attr(
                "src",
                avatar
                  ? `../Images/avatar/${avatar}`
                  : "../Images/avatar/no-avatar.jpg"
              );

              // Gọi danh sách loại sản phẩm ở đây
              fetchProductTypes();
            } else {
              console.error(
                "Không tìm thấy thông tin shop trong dữ liệu tài khoản."
              );
            }
          },
          error: function (xhr) {
            console.error("Lỗi khi gọi API:", xhr.responseText);
          },
        });

        //Hàm gọi API để lấy danh sách sản phẩm theo shopId và productType
        function fetchProductsByType(shopId, productType, accessToken) {
          const apiUrl = `https://localhost:7060/api/Products/shop/${shopId}?FByType=${productType}`;
          console.log(apiUrl);
          $.ajax({
            url: apiUrl,
            type: "GET",
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
            success: function (response) {
              console.log(response); // In ra toàn bộ phản hồi
              console.log(response.totalPage); // Kiểm tra giá trị totalPages
              if (Array.isArray(response.data)) {
                renderProductTable(response.data);
                setupPagination(response.totalPage, 1); // Cập nhật phân trang với trang đầu tiên
              } else {
                console.error("Dữ liệu sản phẩm không đúng định dạng.");
              }
            },
            error: function (xhr) {
              console.error("Lỗi khi gọi API:", xhr.responseText);
            },
          });
        }

        // Hàm xóa sản phẩm
        function deleteProduct(productId) {
          const accessToken = localStorage.getItem("token"); // Lấy token đã lưu trước đó

          $.ajax({
            url: `https://localhost:7060/api/Products/${productId}`,
            type: "DELETE",
            headers: {
              Authorization: `Bearer ${accessToken}`, // Gửi token qua header
            },
            success: function () {
              alert("Xóa sản phẩm thành công!");
              fetchProducts(shopId, accessToken, 1);
            },
            error: function (xhr) {
              console.error("Lỗi khi xóa sản phẩm:", xhr.responseText);

              if (xhr.status === 500) {
                // Giả sử 409 là mã lỗi xung đột khi có ràng buộc
                alert("Sản phẩm không thể xóa vì đang liên kết với đơn hàng.");
              } else {
                alert("Xóa sản phẩm thất bại!");
              }
            },
          });
        }

        function fetchProductTypes(targetSelectId = "#productTypeId") {
          console.log("fetchProductTypes được gọi với ID:", targetSelectId);
          return $.ajax({
            url: "https://localhost:7060/api/ProductTypes",
            method: "GET",
            success: function (response) {
              const $select = $(targetSelectId);
              $select.empty();

              // Thêm option "Tất cả sản phẩm" nếu target là #productTypeId ngoài modal
              if (targetSelectId === "#productTypeId") {
                $select.append(new Option("Tất cả sản phẩm", ""));
              }

              if (response.data && Array.isArray(response.data)) {
                response.data.forEach((type) => {
                  $select.append(new Option(type.name, type.id));
                });
              } else {
                console.error("Dữ liệu không đúng định dạng:", response.data);
              }
            },
            error: function (jqXHR, textStatus, errorThrown) {
              console.error("Lỗi khi gọi API:", textStatus, errorThrown);
            },
          });
        }

        // Lắng nghe sự thay đổi trên <select> ngoài modal
        $("#productTypeId").on("change", function () {
          const productType = $(this).val(); // Lấy giá trị đã chọn
          const shopId = sessionStorage.getItem("shopId");
          if (productType === "") {
            // Nếu chọn "Tất cả sản phẩm" (giá trị rỗng)
            fetchProducts(shopId, accessToken, 1); // Gọi API để lấy tất cả sản phẩm
          } else {
            // Nếu chọn loại sản phẩm cụ thể
            fetchProductsByType(shopId, productType, accessToken); // Gọi API theo loại sản phẩm
          }
        });

        $(".btn-success[data-bs-target='#addProductModal']").on(
          "click",
          function () {
            fetchProductTypes("#addProductTypeId")
              .then(() => {
                console.log(
                  "Danh sách loại sản phẩm đã được cập nhật trong modal."
                );
              })
              .catch((error) => {
                console.error(
                  "Có lỗi xảy ra khi gọi fetchProductTypes:",
                  error
                );
              });
          }
        );

        // Hàm thêm sản phẩm
        $("#submitProduct").on("click", function () {
          const productTypeId = $("#addProductTypeId").val();
          if (!productTypeId) {
            alert("Vui lòng chọn loại sản phẩm.");
            return;
          }

          const productData = {
            name: $("#productName").val(),
            description: $("#productDescription").val(),
            price: parseFloat($("#productPrice").val()),
            quantity: parseInt($("#productQuantity").val()),
            productTypeId: parseInt(productTypeId),
          };

          $.ajax({
            url: "https://localhost:7060/api/Products",
            type: "POST",
            contentType: "application/json",
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
            data: JSON.stringify(productData),

            success: function (response) {
              alert("Thêm sản phẩm thành công!");
              fetchProducts(shopId, accessToken, 1);
              $("#addProductModal").modal("hide");
            },
            error: function (xhr) {
              console.error("Lỗi khi thêm sản phẩm:", xhr.responseText);
              alert("Thêm sản phẩm thất bại!");
            },
          });
        });

        // Gọi API cập nhật sản phẩm khi người dùng nhấn nút "Lưu" trong modal
        $("#saveProductChanges").on("click", function () {
          const productTypeId = $("#editProductTypeId").val();
          const updatedProduct = {
            name: $("#editProductName").val(),
            description: $("#editProductDescription").val(),
            price: parseFloat($("#editProductPrice").val()),
            quantity: parseInt($("#editProductQuantity").val(), 10),
            productTypeId: parseInt(productTypeId),
          };

          $.ajax({
            url: `https://localhost:7060/api/Products/${$(
              "#editProductId"
            ).val()}`,
            method: "PUT",
            headers: {
              Authorization: `Bearer ${accessToken}`, // Thêm token vào tiêu đề
            },
            data: JSON.stringify(updatedProduct),
            contentType: "application/json",
            success: function () {
              alert("Cập nhật sản phẩm thành công!");
              fetchProducts(shopId, accessToken, 1);

              $("#editProductModal").modal("hide");
            },
            error: function (jqXHR, textStatus, errorThrown) {
              console.log(
                "Lỗi cập nhật:",
                jqXHR.responseText || textStatus,
                errorThrown
              );
              alert("Cập nhật sản phẩm thất bại!");
            },
          });
        });
      });
    </script>
    <script>
      $(document).ready(function () {
        let imagePaths = [];

        $(document).on("click", ".product-image", function () {
          const productId = $(this).data("id");
          $("#productImagesModal").data("product-id", productId);
          console.log("Product ID:", productId);
          $.ajax({
            url: `https://localhost:7060/api/Products/${productId}`,
            method: "GET",
            success: function (response) {
              const imagesContainer = $("#productImagesContainer");
              imagesContainer.empty();
              imagePaths = []; // Reset mảng hình ảnh

              // Thêm ảnh vào modal
              response.images.forEach((image) => {
                const imgElement = `
              <div class="col-md-3 mb-2 position-relative"> 
                <i class="fas fa-times-circle text-danger position-absolute top-0 end-0 delete-image-icon" 
                   style="top: -7px; right: 5px;font-size: 1.5rem; cursor: pointer;" 
                   data-id="${image.id}" data-product-id="${productId}"></i>
                <img src="../Images/${image.path}" style="width:200px;height:200px" alt="Hình sản phẩm" class="img-fluid" 
                     onerror="this.onerror=null; this.src='../Images/default-image.jpg';">
              </div>
            `;

                imagesContainer.append(imgElement);
              });

              $("#productImagesModal").modal("show");
            },
            error: function () {
              console.error("Không thể tải hình ảnh sản phẩm.");
            },
          });
        });

        $(document).on("click", ".delete-image-icon", function () {
          const imageId = $(this).data("id");
          const productId = $(this).data("product-id");

          const confirmDelete = confirm(
            "Bạn có chắc chắn muốn xóa hình ảnh này?"
          );
          if (confirmDelete) {
            $.ajax({
              url: `https://localhost:7060/api/Products/${productId}/Images/${imageId}`,
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
              success: function () {
                $(this).parent().remove(); // Xóa ảnh khỏi giao diện

                // Reload lại trang sau khi đóng modal
                $("#productImagesModal").on("hidden.bs.modal", function () {
                  location.reload();
                });

                // Đóng modal khi xóa ảnh thành công
                $("#productImagesModal").modal("hide");
              }.bind(this),
              error: function (jqXHR, textStatus, errorThrown) {
                console.error(
                  "Không thể xóa hình ảnh sản phẩm:",
                  textStatus,
                  errorThrown
                );
                console.error("Chi tiết lỗi:", jqXHR.responseText);
              },
            });
          }
        });

        // Thêm hàm uploadImages
        $(document).on("click", "#uploadButton", function () {
          const productId = $("#productImagesModal").data("product-id");
          uploadImages(productId);
        });

        async function uploadImages(productId) {
          const accessToken = localStorage.getItem("token");
          const imageInput = document.getElementById("imageInput");

          if (imageInput.files.length > 0) {
            const images = Array.from(imageInput.files).map((file) => ({
              path: file.name,
            }));
            console.log("Paths:", images);

            try {
              $.ajax({
                url: `https://localhost:7060/api/Products/${productId}/Images`,
                type: "POST",
                contentType: "application/json",
                headers: {
                  Authorization: `Bearer ${accessToken}`,
                },
                data: JSON.stringify(images),
                success: function (response) {
                  alert("Thêm ảnh thành công");
                  location.reload();
                },
                error: function (xhr, status, error) {
                  console.error(
                    "Failed to upload image paths:",
                    xhr.status,
                    xhr.statusText,
                    "Response:",
                    xhr.responseText
                  );

                  // Hiển thị thông báo lỗi cho người dùng
                  if (xhr.status === 500) {
                    alert("Ảnh đã có rồi. Vui lòng chọn ảnh khác.");
                    // Xóa nội dung của trường nhập ảnh
                    imageInput.value = ""; // hoặc imageInput.files = null; để xóa ảnh đã chọn
                  } else {
                    alert("Có lỗi: " + xhr.statusText);
                  }
                },
              });
            } catch (error) {
              console.error("Error uploading images:", error);
            }
          } else {
            alert("Vui lòng chọn ít nhất một ảnh để tải lên.");
          }
        }
      });
    </script>

    <script>
      $(document).ready(function () {
        $("#footer-container").load("../fragments/footer_2.html");
      });
    </script>
  </body>
</html>
