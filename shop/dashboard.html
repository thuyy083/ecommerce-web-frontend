<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Quản lý sản phẩm</title>

    <link href="../css/style-shop-dashboard.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="icon" href="../Logo/icon.png" type="image/x-icon" />
    <script
      src="https://use.fontawesome.com/releases/v6.3.0/js/all.js"
      crossorigin="anonymous"
    ></script>
    <!-- Thêm jQuery từ CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- jQuery CDN -->

    <!-- Bootstrap JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body class="sb-nav-fixed">
    <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
      <ul class="navbar-nav ms-auto me-3 me-lg-4">
        <li class="nav-item">
          <div class="profile-info d-flex align-items-center">
            <img
              src="../Images/avatar/no-avatar.jpg"
              class="rounded-circle me-2"
              width="32"
              height="32"
              alt="Avatar"
            />
            <span class="text-white">Xin chào, [Tên người dùng]</span>
          </div>
        </li>
        <li class="nav-item ms-3">
          <button id="logoutBtn" class="btn custom-logout-btn">
            Đăng xuất
          </button>
        </li>
      </ul>
    </nav>

    <div id="layoutSidenav">
      <div id="layoutSidenav_nav">
        <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
          <div class="sb-sidenav-menu">
            <div class="nav">
              <div class="sb-sidenav-menu-heading text-center">
                <img
                  src="../Logo/Logo.png"
                  alt="Logo"
                  class="logo-img"
                  style="width: 200px; height: 50px"
                />
              </div>
              <hr />
              <h5 class="text-center">SHOP CỦA TÔI</h5>
              <a class="nav-link" href="dashboard1.html">
                <div class="sb-nav-link-icon">
                  <i class="fas fa-tachometer-alt"></i>
                </div>
                Sản phẩm
              </a>
            </div>
          </div>
        </nav>
      </div>

      <div id="layoutSidenav_content">
        <main>
          <div class="container-fluid px-4">
            <h2 class="mt-4">QUẢN LÝ SẢN PHẨM</h2>
            <div class="card mb-4">
              <div
                class="card-header d-flex justify-content-between align-items-center"
              >
                <div>
                  <i class="fas fa-table me-1"></i>
                  Danh sách sản phẩm
                </div>
                <!-- Nút Thêm sản phẩm ở bên phải -->
                <button
                  class="btn btn-success mt-2"
                  data-bs-toggle="modal"
                  data-bs-target="#addProductModal"
                  style="background-color: #6a9ab0; border: none"
                >
                  <i class="fa-solid fa-plus"></i> Thêm sản phẩm
                </button>
              </div>
              <div class="card-body">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Ảnh</th>
                      <th>Tên</th>
                      <th>Mô tả</th>
                      <th>Giá</th>
                      <th>Số lượng</th>
                      <th>Thao tác</th>
                    </tr>
                  </thead>
                  <tbody id="productTableBody">
                    <!-- Dữ liệu sẽ được chèn tại đây -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </main>
        <footer id="footer-container"></footer>
      </div>
    </div>

    <!-- Modal thêm sản phẩm -->
    <div
      class="modal fade"
      id="addProductModal"
      tabindex="-1"
      aria-labelledby="addProductModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addProductModalLabel">Thêm Sản Phẩm</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addProductForm">
              <div class="mb-3">
                <label for="productName" class="form-label">Tên sản phẩm</label>
                <input
                  type="text"
                  class="form-control"
                  id="productName"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="productDescription" class="form-label">Mô tả</label>
                <textarea
                  class="form-control"
                  id="productDescription"
                  required
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="productPrice" class="form-label">Giá</label>
                <input
                  type="number"
                  class="form-control"
                  id="productPrice"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="productQuantity" class="form-label">Số lượng</label>
                <input
                  type="number"
                  class="form-control"
                  id="productQuantity"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="productTypeId" class="form-label"
                  >Loại sản phẩm</label
                >
                <select class="form-control" id="productTypeId" required>
                  <option value="">Chọn loại sản phẩm</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="submitProduct"
              style="background-color: #6a9ab0; border: none"
            >
              Thêm sản phẩm
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="editProductModal"
      tabindex="-1"
      aria-labelledby="editProductModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editProductModalLabel">Sửa Sản Phẩm</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editProductForm">
              <div class="mb-3">
                <label for="editProductName" class="form-label"
                  >Tên sản phẩm</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="editProductName"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editProductDescription" class="form-label"
                  >Mô tả</label
                >
                <textarea
                  class="form-control"
                  id="editProductDescription"
                  required
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="editProductPrice" class="form-label">Giá</label>
                <input
                  type="number"
                  class="form-control"
                  id="editProductPrice"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editProductQuantity" class="form-label"
                  >Số lượng</label
                >
                <input type="hidden" id="editProductId" />
                <input
                  type="number"
                  class="form-control"
                  id="editProductQuantity"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editProductTypeId" class="form-label"
                  >Loại sản phẩm</label
                >
                <select class="form-control" id="editProductTypeId" required>
                  <option value="">Chọn loại sản phẩm</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="saveProductChanges"
            >
              Cập nhật sản phẩm
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="productImagesModal"
      tabindex="-1"
      aria-labelledby="productImagesModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg" style="height: 500px">
        <div class="modal-content" style="height: 100%">
          <div class="modal-header">
            <h5 class="modal-title" id="productImagesModalLabel">
              Hình ảnh sản phẩm
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div
            class="modal-body"
            style="height: calc(100% - 60px); overflow-y: auto"
          >
            <div id="productImagesContainer" class="row">
              <!-- Các hình ảnh sẽ được thêm vào đây bằng JavaScript -->
            </div>
          </div>
          <div class="modal-footer">
            <form id="uploadForm" class="d-flex align-items-center">
              <div class="mb-3 me-2">
                <label for="imageInput" class="form-label">Thêm ảnh:</label>
                <input
                  type="file"
                  class="form-control"
                  id="imageInput"
                  accept="image/*"
                  multiple
                  required
                />
              </div>
              <button type="button" class="btn btn-primary" id="uploadButton">
                Thêm
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>

    <script>
      $(document).ready(function () {
        logoutBtn.addEventListener("click", function () {
          localStorage.removeItem("token");
          localStorage.removeItem("avatar");
          window.location.href = "../login.html";
        });
        const accessToken = localStorage.getItem("token");

        // Gọi API để lấy thông tin tài khoản
        $.ajax({
          url: "https://localhost:7060/api/Accounts",
          type: "GET",
          headers: {
            Authorization: `Bearer ${accessToken}`, // Gửi token qua header
          },
          success: function (response) {
            // console.log("Response từ API tài khoản:", response); // Log để kiểm tra response

            if (response && response.shop && response.shop.id) {
              const shopId = response.shop.id;
              const shopName = response.shop.name; // Lấy tên của shop từ API
              const avatar = response.avatar;

              // Kiểm tra shopId trước khi lưu
              // console.log("Shop ID:", shopId); // Log shopId
              // console.log("Shop Name:", shopName);
              // Lưu shopId vào sessionStorage
              sessionStorage.setItem("shopId", shopId);

              // Gọi hàm fetchProducts với shopId
              fetchProducts(shopId, accessToken);

              // Cập nhật tên shop vào phần chào mừng
              $(".text-white").text(`Xin chào, ${shopName}`);
              // Kiểm tra và cập nhật avatar nếu có
              if (avatar) {
                $("img.rounded-circle").attr(
                  "src",
                  `../Images/avatar/${avatar}`
                );
              } else {
                $("img.rounded-circle").attr(
                  "src",
                  "../Images/avatar/no-avatar.jpg"
                );
              }
            } else {
              console.error(
                "Không tìm thấy thông tin shop trong dữ liệu tài khoản."
              );
            }
          },
          error: function (xhr) {
            console.error("Lỗi khi gọi API:", xhr.responseText);
          },
        });

        // Gọi API để lấy danh sách loại sản phẩm và thêm vào các select trong modal thêm và sửa sản phẩm
        $.ajax({
          url: "https://localhost:7060/api/ProductTypes",
          type: "GET",
          success: function (response) {
            if (Array.isArray(response.data)) {
              // Xóa các option cũ để tránh bị lặp
              $("#productTypeId, #editProductTypeId").empty();

              response.data.forEach(function (productType) {
                // Thêm các option vào cả hai select
                const option = `<option value="${productType.id}">${productType.name}</option>`;
                $("#productTypeId, #editProductTypeId").append(option);
              });
            } else {
              console.error("Dữ liệu trả về không đúng định dạng.");
            }
          },
          error: function (xhr) {
            console.error(
              "Lỗi khi lấy danh sách loại sản phẩm:",
              xhr.responseText
            );
          },
        });

        $("#submitProduct").on("click", function () {
          const productTypeId = $("#productTypeId").val();

          // Kiểm tra nếu không chọn loại sản phẩm
          if (!productTypeId) {
            alert("Vui lòng chọn loại sản phẩm.");
            return;
          }

          const productData = {
            name: $("#productName").val(),
            description: $("#productDescription").val(),
            price: parseFloat($("#productPrice").val()),
            quantity: parseInt($("#productQuantity").val()),
            productTypeId: parseInt(productTypeId),
          };

          $.ajax({
            url: "https://localhost:7060/api/Products",
            type: "POST",
            contentType: "application/json",
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
            data: JSON.stringify(productData),

            success: function (response) {
              alert("Thêm sản phẩm thành công!");
              fetchProducts(sessionStorage.getItem("shopId"), accessToken);

              location.reload();

              $("#addProductModal").modal("hide");
            },
            error: function (xhr) {
              console.error("Lỗi khi thêm sản phẩm:", xhr.responseText);
              alert("Thêm sản phẩm thất bại!");
            },
          });
        });

        // Hàm gọi API để lấy danh sách sản phẩm
        function fetchProducts(shopId, accessToken) {
          const apiUrl = `https://localhost:7060/api/Products/shop/${shopId}`;

          $.ajax({
            url: apiUrl,
            type: "GET",
            headers: {
              Authorization: `Bearer ${accessToken}`, // Gửi token qua header
            },
            success: function (response) {
              renderProductTable(response.data);
            },
            error: function (xhr) {
              console.error("Lỗi khi gọi API:", xhr.responseText);
            },
          });
        }

        // Hàm render danh sách sản phẩm ra bảng HTML
        function renderProductTable(products) {
          const productTableBody = $("#productTableBody");
          productTableBody.empty();

          products.forEach((product) => {
            const row = `

        <tr>
          <td>
            
                  <img 
          src="${
            product.images.length > 0 && product.images[0]?.path
              ? `../Images/${product.images[0].path}`
              : "../Images/default-image.jpg"
          }"
          class="product-image" 
          data-id="${product.id}" 
          style="cursor: pointer; width: 50px; height: 50px;"> 

          </td>
          <td>${product.name}</td>
          <td>${product.description}</td>
          <td>${(product.price * 1000).toLocaleString()} VND</td>
        
          <td>${product.quantity}</td>
          <td>
            <button
              class="btn btn-success btn-sm btn-update"
              title="Cập nhật"
              data-bs-toggle="modal"
              data-bs-target="#editProductModal"
              data-id="${product.id}"
            >
              <i class="fas fa-edit"></i>
            </button>
           
            <button class="btn btn-danger btn-sm btn-delete" title="Xóa" data-id="${
              product.id
            }">
            <i class="fas fa-trash-alt"></i>
          </button>
            
          </td>
        
         
        </tr>
      `;
            productTableBody.append(row);
          });

          // Gắn sự kiện click cho nút xóa
          $(".btn-delete").on("click", function () {
            const productId = $(this).data("id");
            if (confirm("Bạn có chắc chắn muốn xóa sản phẩm này?")) {
              deleteProduct(productId);
            }
          });

          // Gắn sự kiện click cho nút cập nhật
          $(".btn-update").on("click", function () {
            const productId = $(this).data("id");

            // Tiếp tục gọi API để lấy dữ liệu chi tiết sản phẩm
            $.ajax({
              url: `https://localhost:7060/api/Products/${productId}`,
              method: "GET",
              success: function (product) {
                $("#editProductName").val(product.name);
                $("#editProductDescription").val(product.description);
                $("#editProductPrice").val(product.price);
                $("#editProductQuantity").val(product.quantity);
                $("#editProductId").val(product.id); // Lưu ID vào input ẩn
              },

              error: function () {
                alert("Không thể tải dữ liệu sản phẩm!");
              },
            });
          });
        }

        // Gọi API cập nhật sản phẩm khi người dùng nhấn nút "Lưu" trong modal
        $("#saveProductChanges").on("click", function () {
          const updatedProduct = {
            name: $("#editProductName").val(),
            description: $("#editProductDescription").val(),
            price: parseFloat($("#editProductPrice").val()),
            quantity: parseInt($("#editProductQuantity").val(), 10),
            productTypeId: parseInt($("#editProductTypeId").val(), 10),
          };

          //console.log("Dữ liệu gửi đi:", JSON.stringify(updatedProduct)); // Kiểm tra cấu trúc gửi đi
          const token = localStorage.getItem("token"); // Lấy token đã lưu trước đó

          $.ajax({
            url: `https://localhost:7060/api/Products/${$(
              "#editProductId"
            ).val()}`,
            method: "PUT",
            headers: {
              Authorization: `Bearer ${token}`, // Thêm token vào tiêu đề
            },
            data: JSON.stringify(updatedProduct),
            contentType: "application/json",
            success: function () {
              alert("Cập nhật sản phẩm thành công!");
              location.reload();
              $("#editProductModal").modal("hide");
            },
            error: function (jqXHR, textStatus, errorThrown) {
              console.log(
                "Lỗi cập nhật:",
                jqXHR.responseText || textStatus,
                errorThrown
              );
              alert("Cập nhật sản phẩm thất bại!");
            },
          });
        });
        // Hàm xóa sản phẩm
        function deleteProduct(productId) {
          const accessToken = localStorage.getItem("token"); // Lấy token đã lưu trước đó

          $.ajax({
            url: `https://localhost:7060/api/Products/${productId}`,
            type: "DELETE",
            headers: {
              Authorization: `Bearer ${accessToken}`, // Gửi token qua header
            },
            success: function () {
              alert("Xóa sản phẩm thành công!");
              location.reload();
            },
            error: function (xhr) {
              console.error("Lỗi khi xóa sản phẩm:", xhr.responseText);
              alert("Xóa sản phẩm thất bại!");
            },
          });
        }
      });
    </script>
    <script>
      $(document).ready(function () {
        let imagePaths = [];

        $(document).on("click", ".product-image", function () {
          const productId = $(this).data("id");
          $("#productImagesModal").data("product-id", productId); // Gán productId vào modal
          console.log("Product ID:", productId);
          $.ajax({
            url: `https://localhost:7060/api/Products/${productId}`,
            method: "GET",
            success: function (response) {
              const imagesContainer = $("#productImagesContainer");
              imagesContainer.empty(); // Xóa hình ảnh cũ trước khi thêm mới
              imagePaths = []; // Reset mảng hình ảnh

              // Thêm ảnh vào modal
              response.images.forEach((image) => {
                const imgElement = `
              <div class="col-md-3 mb-2 position-relative"> 
                <i class="fas fa-times-circle text-danger position-absolute top-0 end-0 delete-image-icon" 
                   style="top: -7px; right: 5px;font-size: 1.5rem; cursor: pointer;" 
                   data-id="${image.id}" data-product-id="${productId}"></i>
                <img src="../Images/${image.path}" style="width:200px;height:200px" alt="Hình sản phẩm" class="img-fluid" 
                     onerror="this.onerror=null; this.src='../Images/default-image.jpg';">
              </div>
            `;

                imagesContainer.append(imgElement);
              });

              // Hiển thị modal
              $("#productImagesModal").modal("show");
            },
            error: function () {
              console.error("Không thể tải hình ảnh sản phẩm.");
            },
          });
        });

        $(document).on("click", ".delete-image-icon", function () {
          const imageId = $(this).data("id");
          const productId = $(this).data("product-id");

          // Xác nhận xóa ảnh
          const confirmDelete = confirm(
            "Bạn có chắc chắn muốn xóa hình ảnh này?"
          );
          if (confirmDelete) {
            $.ajax({
              url: `https://localhost:7060/api/Products/${productId}/Images/${imageId}`,
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`, // Thêm token nếu cần
              },
              success: function () {
                $(this).parent().remove(); // Xóa ảnh khỏi giao diện
              }.bind(this),
              error: function (jqXHR, textStatus, errorThrown) {
                console.error(
                  "Không thể xóa hình ảnh sản phẩm:",
                  textStatus,
                  errorThrown
                );
                console.error("Chi tiết lỗi:", jqXHR.responseText);
              },
            });
          }
        });

        // Thêm hàm uploadImages
        $(document).on("click", "#uploadButton", function () {
          // Thay #uploadButton bằng id hoặc class của nút upload
          const productId = $("#productImagesModal").data("product-id"); // Lấy productId từ modal
          uploadImages(productId);
        });

        async function uploadImages(productId) {
          const accessToken = localStorage.getItem("token");

          const imageInput = document.getElementById("imageInput");
          if (imageInput.files.length > 0) {
            // Tạo mảng chứa đường dẫn của tất cả các ảnh
            const images = Array.from(imageInput.files).map((file) => ({
              path: file.name,
            }));
            console.log("Paths:", images); // Kiểm tra danh sách các đường dẫn

            try {
              $.ajax({
                url: `https://localhost:7060/api/Products/${productId}/Images`, // Sử dụng productId
                type: "POST",
                contentType: "application/json",
                headers: {
                  Authorization: `Bearer ${accessToken}`,
                },
                data: JSON.stringify(images),
                success: function (response) {
                  alert("Thêm ảnh thành công");
                  location.reload();
                },
                error: function (xhr, status, error) {
                  console.error(
                    "Failed to upload image paths:",
                    xhr.status,
                    xhr.statusText,
                    "Response:",
                    xhr.responseText
                  );
                },
              });
            } catch (error) {
              console.error("Error uploading images:", error);
            }
          }
        }
      });
    </script>

    <script>
      $(document).ready(function () {
        $("#footer-container").load("../fragments/footer_2.html");
      });
    </script>
  </body>
</html>
