<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý chương trình giảm giá</title>

   <!-- Bootstrap CSS -->
   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
   <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    
   <!-- Font Awesome -->
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0-beta3/css/all.min.css">
   <!-- Bootstrap JS -->
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- giao diện -->
    <link href="../css/style_shop_dashboard.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="icon" href="../Logo/icon.png" type="image/x-icon" />
    <script
      src="https://use.fontawesome.com/releases/v6.3.0/js/all.js"
      crossorigin="anonymous"
    ></script>
    <!-- giao diện -->
  
    <!-- Bootstrap JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="../css/style_index.css" />

   

    <style>
        
        #layoutSidenav {
            display: flex;
        }
        
        #viewImage {
            text-align: center;
            margin-bottom: 20px;
        }
        #viewImage img {
            max-width: 100%;
            height: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .form-group label {
            font-weight: bold;
        }
        .checkbox-group {
            display: flex;
            gap: 15px;
        }
       
    </style>
</head>
<body class="sb-nav-fixed">
    <nav class="sb-topnav navbar navbar-expand ">
      <ul class="navbar-nav ms-auto me-3 me-lg-4">
        <li class="nav-item dropdown">
          <a
            class="nav-link dropdown-toggle d-flex align-items-center gap-2"
            id="navbarDropdown"
            href="#"
            role="button"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            <div class="profile-info d-flex align-items-center">
              <img
                src="../Images/avatar/no-avatar.jpg"
                class="rounded-circle"
                width="32"
                height="32"
              />
            </div>
          </a>
          <ul
            class="dropdown-menu dropdown-menu-end shadow-sm"
            aria-labelledby="navbarDropdown"
            style="min-width: 200px"
          >
            <li class="d-flex align-items-center p-2">
              <img
                src="../Images/avatar/no-avatar.jpg"
                class="rounded-circle me-2"
                width="32"
                height="32"
                alt="Profile picture"
              />
              <div class="ms-2">
                <div class="name">Hizrian</div>
                <div class="email text-muted small">hello@example.com</div>
              </div>
            </li>

            <li><hr class="dropdown-divider" /></li>
            <li>
              <a class="dropdown-item" href="../index.html" style="display: inline-block">
                Đăng xuất
                <i
                  class="fa-solid fa-arrow-right-from-bracket"
                  style="margin-left: 5px"
                ></i>
              </a>
            </li>
          </ul>
        </li>
      </ul>
    </nav>
    <div id="layoutSidenav">
        <div id="layoutSidenav_nav">
          <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
            <div class="sb-sidenav-menu">
              <div class="nav">
                <div class="sb-sidenav-menu-heading text-center">
                  <img
                    src="../Logo/Logo.png"
                    alt="Logo"
                    class="logo-img"
                    style="width: 200px; height: 50px"
                  />
                </div>
                <hr />
                <h5 class="text-center">Quản Lý</h5>
                <a class="nav-link" href="sale-admin.html">
                  Sale Event
                </a>
              </div>
            </div>
          </nav>
        </div>
        <div id="layoutSidenav_content">
            <main>
                <div class="container-fluid">
                    <div class="container">
                        <div class="p-2" style="background-color: #3a6d8c; color: #ffffff;"> <h1>Danh sách chương trình giảm giá</h1></div>
                        <div>
                            <table class="table table-bordered">
                                <thead class="text-center" style="background-color: #ead8b1;">
                                    <tr>
                                        <th>STT</th>
                                        <th>Hình</th>
                                        <th>Tên</th>
                                        <th>Mô tả</th>
                                        <th>%</th>
                                        <th>Bắt đầu</th>
                                        <th>Kết thúc</th>
                                        <th>Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="saleEventsTable">
                                    <!-- Dữ liệu sẽ được thêm động ở đây -->
                                </tbody>
                            </table>
                            <!-- Thông báo khi không có dữ liệu -->
                            <div id="noDataMessage" class="text-center mt-3" style="display: none;">
                                Không có chương trình giảm giá nào được tìm thấy.
                            </div>
                        </div>
                        
                        <!-- Khu vực phân trang -->
                            <!-- Nút phân trang sẽ được thêm động -->
                        
                        <div class="d-flex justify-content-center mb-4 mt-4">
                            <div id="pagination" class="d-flex justify-content-center"></div>
                            <button class="btn btn-auth " data-toggle="modal" data-target="#addSaleEventModal">Thêm chương trình giảm giá</button>
                        </div>
                    </div>
                </div>
                
                
                
                <div id="footer-container"></div>

            </main>
        </div>
<!-- Modal Thêm Chương Trình Giảm Giá -->
<div class="modal fade" id="addSaleEventModal" tabindex="-1" role="dialog" aria-labelledby="addSaleEventModalLabel" aria-hidden="true" >
    <div class="modal-dialog modal-lg" >
        <div class="modal-content" style="background-color: #edeef1;">
            <div class="modal-header" style="background-color: #ead8b1;">
                <h5 class="modal-title" >Thêm chương trình giảm giá</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addSaleEventForm" enctype="multipart/form-data">
                    <div class="form-group d-flex align-items-center justify-content-center">
                    <label for="currentIllustration1" class="font-weight-bold pe-3"><h5>Hình minh họa</h5></label></div>
                    <div class="form-group d-flex align-items-center justify-content-center">
                        <div class="d-flex align-items-center">
                            <label for="editIllustration1" class="btn" style="display: inline-flex; align-items: center;">
                                <img id="currentIllustration1" src="../Images/default-image.jpg" alt="Current Illustration" height="150px" width="650px" style="margin-right: 10px;">
                            </label>
                            <input type="file" class="d-none" id="editIllustration1" accept="image/*">
                        </div>
                    </div>
                    <div style="flex: 1; margin-right: 30px; margin-left: 30px;">
                        <div class="mb-3 d-flex justify-content-between">
                            <div style="flex: 1; margin-right: 50px; margin-left: 30px;">
                                <label for="name" class="form-label font-weight-bold">Tên</label>
                                <input type="text" class="form-control" id="name" required>
                            </div>
                            <div style="flex: 1; margin-right: 30px;">
                                <label for="discount" class="form-label font-weight-bold">Giảm giá (%)</label>
                                <input type="number" class="form-control" id="discount" required min="0" max="100">
                            </div>
                        </div>
                        <div class="mb-3 d-flex">
                            <div style="flex: 1; margin-right: 50px; margin-left: 30px;">
                                <label for="startDate" class="form-label font-weight-bold">Ngày bắt đầu</label>
                                <input type="datetime-local" class="form-control" id="startDate" required>
                            </div>
                            <div style="flex: 1; margin-right: 30px;">
                                <label for="endDate" class="form-label font-weight-bold">Ngày kết thúc</label>
                                <input type="datetime-local" class="form-control" id="endDate" required>
                            </div>
                        </div>
                       
                        <div class="mb-3 d-flex justify-content-between">
                            <div style="flex: 1; margin-right: 60px; margin-left: 30px;">
                                <label class="form-label font-weight-bold">Loại khách hàng</label>
                                <select id="customerTypeSelect" class="form-control" multiple required>
                                    <option value="" disabled>Chọn loại khách hàng</option>
                                    <!-- Các loại khách hàng sẽ được thêm vào đây bằng JavaScript -->
                                </select>
                            </div>
                            <div style="flex: 1; margin-right: 30px;">
                                <label class="form-label font-weight-bold">Sản phẩm</label>
                                <select id="productIds" class="form-control" multiple required>
                                    <option value="" disabled>Chọn sản phẩm</option>
                                    <!-- Các sản phẩm sẽ được thêm vào đây bằng JavaScript -->
                                </select>
                            </div>
                        </div>
                        <div class="mb-3" style="flex: 1; margin-right: 35px; margin-left: 30px;">
                            <label for="description" class="form-label font-weight-bold">Mô tả</label>
                            <textarea class="form-control" id="description" rows="3"></textarea>
                        </div>
                    </div>
                    
                </form>
            </div>
            
            <div class="modal-footer" style="flex: 1; margin-right: 35px; ">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-auth" id="saveSaleEvent">Lưu</button>
            </div>
        </div>
    </div>
</div>




<!-- Modal Sửa Chương Trình -->
<div class="modal fade" id="editSaleEventModal" tabindex="-1" role="dialog" aria-hidden="true" aria-labelledby="editSaleEventModal">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: #edeef1;">
            <div class="modal-header" style="background-color: #ead8b1;">
                <h5 class="modal-title">Sửa thông tin chương trình giảm giá</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editSaleEventForm">
                    <input type="hidden" id="editSaleEventId">
                    <div class="form-group d-flex align-items-center justify-content-center">
                        <div class="d-flex align-items-center">
                            <label for="editIllustration" class="btn" style="display: inline-flex; align-items: center;">
                                <img id="currentIllustration" src="" alt="Current Illustration" height="100px" width="400px" style="margin-right: 10px;">
                            </label>
                            <input type="file" class="d-none" id="editIllustration" accept="image/*">
                        </div>
                    </div>
                    <div style="margin-left: 30px; margin-right: 30px;">
                        <div class="form-group">
                            <label for="editName">Tên</label>
                            <input type="text" class="form-control" id="editName" required>
                        </div>
                        <div class="form-group">
                            <label for="editDescription">Mô tả</label>
                            <textarea class="form-control" id="editDescription" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="editDiscount">Giảm giá (%)</label>
                            <input type="number" class="form-control" id="editDiscount" required min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label for="editStartDate">Ngày bắt đầu</label>
                            <input type="datetime-local" class="form-control" id="editStartDate" required>
                        </div>
                        <div class="form-group">
                            <label for="editEndDate">Ngày kết thúc</label>
                            <input type="datetime-local" class="form-control" id="editEndDate" required>
                        </div>
                    </div>
                    
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-auth" id="updateSaleEvent">Cập nhật</button>
            </div>
        </div>
    </div>
</div>

<script>
    
    $(document).ready(function () {
        const accessToken = localStorage.getItem("token");
        if (!accessToken) {
            alert("Không tìm thấy token, vui lòng đăng nhập lại.");
            return;
        }
        
        loadSaleEvents();

        //hàm lấy danh sách loại người dùng 
        function loadCustomerOptions() {
            $.ajax({
                url: 'https://localhost:7060/api/CustomerTypes',
                method: 'GET',
                headers: { Authorization: `Bearer ${accessToken}` },
                success: function(data) {
                    const customerTypeSelect = $('#customerTypeSelect');
                    customerTypeSelect.empty();
                    data.forEach(function(customerType) {
                        customerTypeSelect.append(`
                            <option value="${customerType.id}">${customerType.name}</option>
                        `);
                    });
                },
                error: function(xhr) {
                    console.error("Có lỗi xảy ra:", xhr.responseText);
                    alert("Có lỗi xảy ra khi tải loại khách hàng.");
                }
            });
        }
        

        function loadProductOptions() {
            $.ajax({
                url: 'https://localhost:7060/api/Products',
                method: 'GET',
                headers: { Authorization: `Bearer ${accessToken}` },
                success: function(response) {
                    console.log("API Response:", response); // Kiểm tra xem `response` có phải là mảng không
                    
                    const products = Array.isArray(response) ? response : response.data; // Điều chỉnh nếu API trả về dữ liệu trong `{ data: [...] }`
                    const productSelect = $('#productIds');
                    productSelect.empty(); // Xóa nội dung cũ trước khi thêm sản phẩm mới
                    
                    if (products && products.length > 0) {
                        products.forEach(function(product) {
                            productSelect.append(`
                                <option value="${product.id}">${product.name}</option>
                            `);
                        });
                    } else {
                        productSelect.append('<div class="text-muted">Không có sản phẩm nào để chọn.</div>'); // Thông báo nếu không có sản phẩm
                    }
                },
                error: function(xhr) {
                    console.error("Có lỗi xảy ra:", xhr.responseText);
                    alert("Có lỗi xảy ra khi tải sản phẩm.");
                }
            });
        }



        $('#addSaleEventModal').on('show.bs.modal', function () {
            loadCustomerOptions();
            loadProductOptions();
        });

        // Lấy danh sách chương trình giảm giá
        let saleEventsData = []; // Mảng lưu trữ dữ liệu toàn bộ
        let currentPage = 1;
        const pageSize = 5; // Số mục trên mỗi trang

        // Lấy danh sách chương trình giảm giá
        function loadSaleEvents() {
            $.ajax({
                url: 'https://localhost:7060/api/Sales',
                method: 'GET',
                success: function(response) {
                    if (response && Array.isArray(response.data)) {
                        saleEventsData = response.data; // Lưu dữ liệu vào mảng
                        renderPage(currentPage); // Hiển thị trang đầu tiên
                        renderPagination();
                    } else {
                        console.error("Dữ liệu trả về không phải là mảng:", response.data);
                        $('#noDataMessage').show();
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Có lỗi xảy ra:", error);
                }
            });
        }

        // Hiển thị một trang cụ thể
        function renderPage(page) {
            const startIndex = (page - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageData = saleEventsData.slice(startIndex, endIndex);

            $('#saleEventsTable').empty();
            pageData.forEach((item, index) => {
                const imagePath = item.illustration.startsWith("data:image") 
                    ? item.illustration 
                    : `/Images/${item.illustration}`;

                const row = `
                    <tr>
                        <td>${startIndex + index + 1}</td>
                        <td><img src="${imagePath}" height="50px" width="100px" alt="${item.name}"></td>
                        <td>${item.name}</td>
                        <td>${item.description}</td>
                        <td>${item.discount * 100}%</td>
                        <td>${new Date(item.startDate).toLocaleDateString()}</td>
                        <td>${new Date(item.endDate).toLocaleDateString()}</td>
                        <td>
                            <div class="d-flex align-items-center mt-3">
                                <button class="btn btn-warning btn-sm edit-button" data-id="${item.id}"><i class="fas fa-edit"></i></button>
                                <button style="margin-left: 5px;" class="btn btn-danger btn-sm delete-button" data-id="${item.id}"><i class="fas fa-trash-alt"></i></button>
                                <button style="margin-left: 5px;" class="btn btn-info btn-sm view-button" data-id="${item.id}" onclick="window.location.href='sale-admin-detail.html?id=${item.id}'">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
                $('#saleEventsTable').append(row);
            });
        }

        



        //cập nhật khi chọn ảnh khi thêm chương trình giảm giá
        $('#editIllustration1').change(function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    $('#currentIllustration1').attr('src', e.target.result); // Cập nhật ảnh xem trước
                };
                reader.readAsDataURL(file);
            }
        });


        //thêm chương trình giảm giá
        $('#saveSaleEvent').click(function () {
    const illustrationFile = $('#editIllustration1')[0].files[0];
    if (!illustrationFile) {
        alert("Vui lòng chọn một hình minh họa.");
        return;
    }

    const fileName = illustrationFile.name;

    const selectedCustomerTypeIds = $('#customerTypeSelect').val(); // Lấy tất cả giá trị đã chọn từ select
    const selectedProductIds = $('#productIds').val(); // Lấy tất cả giá trị đã chọn từ select


    const saleEvent = {
        name: $('#name').val().trim(),
        description: $('#description').val().trim(),
        illustration: fileName,
        discount: parseFloat($('#discount').val()) / 100,
        startDate: $('#startDate').val(),
        endDate: $('#endDate').val(),
        customerTypeIds: selectedCustomerTypeIds,
        productIds: selectedProductIds
    };

    if (!saleEvent.customerTypeIds.length) {
        alert("Vui lòng chọn loại khách hàng.");
        return;
    }
    if (!saleEvent.productIds.length) {
        alert("Vui lòng chọn ít nhất một sản phẩm.");
        return;
    }

    $.ajax({
        url: 'https://localhost:7060/api/Sales',
        method: 'POST',
        contentType: 'application/json',
        headers: { Authorization: `Bearer ${accessToken}` },
        data: JSON.stringify(saleEvent),
        success: function () {
            
            
            alert("Chương trình giảm giá đã được thêm thành công!");
            $('#addSaleEventModal').modal('hide');
            loadSaleEvents();
        },
        error: function (xhr) {
            console.error("Có lỗi xảy ra:", xhr.responseText);
            alert("Có lỗi xảy ra: " + xhr.responseText);
        }
    });
});

   


        // Chỉnh sửa chương trình giảm giá
        $(document).on('click', '.edit-button', function () {
            const id = $(this).data('id');
            $.ajax({
                url: `https://localhost:7060/api/Sales/${id}`,
                method: 'GET',
                headers: { Authorization: `Bearer ${accessToken}` },

                success: function(response) {
                    $('#editSaleEventId').val(response.id);
                    $('#editName').val(response.name);
                    $('#editDescription').val(response.description);
                    $('#editDiscount').val(response.discount * 100); // Hiển thị giảm giá theo %
                    $('#editStartDate').val(new Date(response.startDate).toISOString().substring(0, 16));
                    $('#editEndDate').val(new Date(response.endDate).toISOString().substring(0, 16));

                    // Cập nhật và hiển thị ảnh minh họa hiện tại
                    let imagePath = response.illustration.startsWith("data:image") ? response.illustration : `/Images/${response.illustration}`;
                    $('#currentIllustration').attr('src', imagePath);

                    $('#editSaleEventModal').modal('show');
                }
            });
        });

        // Cập nhật ảnh minh họa khi chọn ảnh mới
        $('#editIllustration').change(function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // Hiển thị ảnh đã chọn
                $('#currentIllustration').attr('src', e.target.result);
            };
            reader.readAsDataURL(file);
        }
    });

    

    $('#updateSaleEvent').click(function () {
    const illustrationFile = $('#editIllustration')[0].files[0]; // Lấy file ảnh mới

    let saleEvent = {
        id: $('#editSaleEventId').val(),
        name: $('#editName').val(),
        description: $('#editDescription').val(),
        discount: parseFloat($('#editDiscount').val()) / 100,
        startDate: $('#editStartDate').val(),
        endDate: $('#editEndDate').val(),
        illustration: '' // Chỉ lưu tên file vào cơ sở dữ liệu
    };

    if (illustrationFile) {
        const fileName = illustrationFile.name; // Lưu tên file
        // Chú ý: không có khả năng lưu file vào server
        // Bạn cần một cách để sao chép file vào thư mục Images từ đây
        saleEvent.illustration = fileName; // Cập nhật tên file vào đối tượng saleEvent
    } else {
        // Nếu không chọn file mới, giữ nguyên tên file cũ
        saleEvent.illustration = $('#currentIllustration').attr('src').split('/').pop(); // Lấy tên file hiện tại
    }

    // Gửi yêu cầu cập nhật
    $.ajax({
        url: `https://localhost:7060/api/Sales/${saleEvent.id}`,
        method: 'PUT',
        contentType: 'application/json',
        headers: { Authorization: `Bearer ${accessToken}` },

        data: JSON.stringify(saleEvent),
        success: function () {
            $('#editSaleEventModal').modal('hide');
            loadSaleEvents();
        },
        error: function (xhr) {
            console.error("Có lỗi xảy ra:", xhr.responseText);
        }
    });
});

    // Hàm để thực hiện yêu cầu PUT cập nhật chương trình giảm giá
    function updateSaleEvent(saleEvent) {
        $.ajax({
            url: `https://localhost:7060/api/Sales/${saleEvent.id}`,
            method: 'PUT',
            contentType: 'application/json',
            headers: { Authorization: `Bearer ${accessToken}` },

            data: JSON.stringify(saleEvent),
            success: function () {
                $('#editSaleEventModal').modal('hide');
                loadSaleEvents(); // Tải lại danh sách sau khi cập nhật thành công
            },
            error: function (xhr) {
                console.error("Có lỗi xảy ra:", xhr.responseText);
            }
        });
    }
        // Xóa chương trình giảm giá
        $(document).on('click', '.delete-button', function () {
            const id = $(this).data('id');
            if (confirm("Bạn có chắc chắn muốn xóa chương trình này không?")) {
                $.ajax({
                    url: `https://localhost:7060/api/Sales/${id}`,
                    method: 'DELETE',
                    headers: { Authorization: `Bearer ${accessToken}` },

                    success: function () {
                        loadSaleEvents();
                    },
                    error: function (xhr) {
                        console.error("Có lỗi xảy ra:", xhr.responseText);
                    }
                });
            }
        });
       // Cập nhật hàm renderPagination
        function renderPagination() {
            const totalPages = Math.ceil(saleEventsData.length / pageSize);
            $('#pagination').empty();

            for (let i = 1; i <= totalPages; i++) {
                const pageButton = $(`<button class="btn ${i === currentPage ? 'btn-auth' : 'btn-secondary'} mx-1">Trang ${i}</button>`);
                pageButton.on('click', function() {
                    changePage(i);
                });
                $('#pagination').append(pageButton);
            }
        }

        // Đảm bảo changePage được định nghĩa trong $(document).ready
        function changePage(page) {
            currentPage = page;
            renderPage(currentPage);
            renderPagination();
        }


        // Chạy hàm loadSaleEvents để tải dữ liệu khi trang được tải
        $(document).ready(function() {
            loadSaleEvents();
        });

    });
</script>
<script>
    $(document).ready(function() { 
        //$('#navbar-container').load('./fragments/navbar.html', function(response, status, xhr) {});
        $('#footer-container').load('../fragments/footer_2.html', function(response, status, xhr) {});
    });

</script>
</body>
</html>
